# Smart Screen - 业务规则

> **层级**: L2 - 业务与领域（What）  
> **角色**: 业务专家 / 架构师  
> **本质**: 问题空间建模

## 录制规则

### 规则 R1：权限检查

**规则描述**：录制前必须获取必要的系统权限

**业务逻辑**：
```
BEFORE 开始录制:
    IF 未获取屏幕录制权限 THEN
        请求屏幕录制权限
        IF 用户拒绝 THEN
            显示权限说明，引导用户到系统设置
            终止录制流程
    
    IF 需要麦克风 AND 未获取麦克风权限 THEN
        请求麦克风权限
        IF 用户拒绝 THEN
            警告用户将无音频录制
            允许继续（静音模式）
    
    IF 需要摄像头 AND 未获取摄像头权限 THEN
        请求摄像头权限
        IF 用户拒绝 THEN
            警告用户将无摄像头叠加
            允许继续（无 PiP）
```

**例外情况**：
- 用户主动跳过权限请求
- 系统版本不支持某些权限 API

---

### 规则 R2：系统音频捕获

**规则描述**：系统音频捕获需要虚拟音频驱动

**业务逻辑**：
```
IF 用户选择录制系统音频 THEN
    检测是否安装虚拟音频驱动（BlackHole/Loopback）
    IF 未安装 THEN
        显示安装引导
        提供一键检测脚本
        允许用户跳过（无系统音频）
    ELSE
        自动配置音频路由
        验证音频捕获正常
```

**推荐驱动**：
- BlackHole（免费开源）
- Loopback（付费，功能更强）

---

### 规则 R3：长时录制策略

**规则描述**：长时录制需要特殊的内存和磁盘管理

**业务逻辑**：
```
录制时:
    使用环形磁盘缓存，避免内存线性增长
    每 5 分钟自动保存检查点
    
    IF 可用磁盘空间 < 1GB THEN
        警告用户磁盘空间不足
        
    IF 可用磁盘空间 < 500MB THEN
        自动停止录制
        保存已录制内容
        
    IF 录制时长 > 2小时 THEN
        自动分段保存（每段 30 分钟）
        最后合并为完整文件
```

**违反后果**：可能导致录制丢失或文件损坏

---

## 增强规则

### 规则 R4：Auto Zoom 参数约束

**规则描述**：Auto Zoom 参数必须在合理范围内

**业务逻辑**：
```
Auto Zoom 配置:
    zoomLevel: 1.0 ~ 3.0（默认 2.0）
    duration: 0.2s ~ 2.0s（默认 0.5s）
    margin: 50px ~ 200px（默认 100px）
    
    IF zoomLevel > 3.0 THEN
        限制为 3.0，警告用户
        
    IF 热点区域过小（< 100x100px）THEN
        扩展到最小尺寸
        
    IF 热点切换过于频繁（< 1s 间隔）THEN
        合并相邻热点
        避免画面抖动
```

---

### 规则 R5：竖屏模式 Auto Zoom 重映射

**规则描述**：导出竖屏（9:16）时，Auto Zoom 参数需要重新计算

**业务逻辑**：
```
IF 导出宽高比 = 9:16 THEN
    重新计算热点中心点
    调整 zoom margin 适应竖屏
    优先保留水平方向的上下文
    
    热点映射公式:
    newCenterX = originalCenterX
    newCenterY = originalCenterY * (16/9) / (9/16)
    newZoomLevel = originalZoomLevel * 0.8  // 竖屏需要更小的缩放
```

---

### 规则 R6：Cursor Smoothing 级别

**规则描述**：光标平滑级别影响算法选择

**业务逻辑**：
```
平滑级别配置:
    低（Low）:
        算法: EWMA（α = 0.3）
        延迟: < 1 帧
        适用: 快速操作演示
        
    中（Medium）:
        算法: Kalman Filter
        延迟: 1-2 帧
        适用: 一般教程
        
    高（High）:
        算法: Kalman + Bezier 插值
        延迟: 2-3 帧
        适用: 专业演示视频
```

---

## 编辑规则

### 规则 R7：非破坏性编辑

**规则描述**：所有编辑操作必须保留原始素材

**业务逻辑**：
```
编辑操作:
    不直接修改原始视频文件
    所有变更存储在时间线元数据中
    
    时间线结构:
    {
        "segments": [
            {
                "sourceRange": { "start": 0, "end": 5 },
                "outputRange": { "start": 0, "end": 5 },
                "speed": 1.0,
                "effects": []
            }
        ]
    }
    
    导出时:
        按时间线重新组合
        应用变换和效果
        生成新文件
        
    原始素材:
        始终保留
        支持随时回溯
```

---

### 规则 R8：变速音频处理

**规则描述**：视频变速时音频需要同步处理

**业务逻辑**：
```
IF 视频速度改变 THEN
    音频处理策略:
    
    IF speed <= 0.5x OR speed >= 2.0x THEN
        静音处理（音频失真严重）
        
    ELSE IF 用户选择保持音高 THEN
        应用 pitch correction
        使用时间拉伸算法
        
    ELSE
        直接变速（音高随速度变化）
```

---

## 导出规则

### 规则 R9：预设参数验证

**规则描述**：导出参数必须符合格式要求

**业务逻辑**：
```
导出前验证:
    IF format = "GIF" THEN
        最大分辨率: 1280x720
        最大帧率: 30fps
        最大时长: 30s
        IF 超出限制 THEN
            自动调整或警告用户
            
    IF format = "MP4" THEN
        编码器: H.264 或 HEVC
        容器: MP4
        音频: AAC
        
    IF format = "MOV" THEN
        编码器: ProRes 或 H.264
        容器: MOV
        音频: AAC 或 PCM
```

---

### 规则 R10：导出文件命名

**规则描述**：导出文件自动命名规则

**业务逻辑**：
```
默认文件名格式:
    SmartScreen_{日期}_{时间}_{序号}.{格式}
    
示例:
    SmartScreen_20260113_143052_001.mp4
    
IF 文件已存在 THEN
    自动递增序号
    
IF 用户自定义名称 THEN
    验证文件名合法性
    替换非法字符
```

---

## 性能规则

### 规则 R11：资源占用限制

**规则描述**：录制时资源占用必须在可接受范围内

**业务逻辑**：
```
性能目标（M1 及以上芯片）:
    CPU 占用: < 30%
    内存占用: < 500MB
    磁盘写入: < 50MB/s（1080p@30fps）
    
IF CPU 占用 > 50% THEN
    自动降低编码质量
    记录性能日志
    
IF 内存占用 > 1GB THEN
    强制刷新缓冲区到磁盘
    警告用户
```

---

### 规则 R12：帧率与分辨率联动

**规则描述**：高分辨率时自动限制帧率

**业务逻辑**：
```
分辨率-帧率限制:
    4K (3840x2160): 最高 60fps
    1080p (1920x1080): 最高 120fps
    720p (1280x720): 最高 120fps
    
IF 用户选择超出限制的组合 THEN
    自动调整帧率
    提示用户
```

---

## 规则变更管理

### 变更流程
1. 提出变更需求
2. 影响评估（性能、兼容性、用户体验）
3. 技术评审
4. 更新文档
5. 实现并测试
6. 发布说明

### 版本记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-01-13 | 初始版本 |

## 相关文档

- [领域模型](../domain-models/domain-model.md)
- [业务流程](../business-processes/workflow.md)
- [技术设计](../../03-specifications/)
